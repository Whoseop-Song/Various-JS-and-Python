(function(){var t,e={}.hasOwnProperty,n=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t};t=function(t){function e(){e.__super__.constructor.apply(this,arguments)}return n(e,t),e.prototype.routes={"":"index",search:"search","my-shelf":"myShelf","modal-info/:id":"showModelInfo"},e.prototype.initialize=function(){},e.prototype.index=function(){return this.navigate("search",{trigger:!0}),!1},e.prototype.search=function(){return this.mainView.showSearch()},e.prototype.myShelf=function(){return this.mainView.showMyShelf()},e.prototype.showModelInfo=function(t){return this.myShelf(),this.mainView.myShelfView.showModelInfo(t)},e.prototype.start=function(){return this.mainView=new this.MainView,Backbone.history.start({pushState:!1}),app.myBooks.fetch(),$(document).delegate("a","click",function(t){var e,n;return e=$(this).attr("href"),n=this.protocol+"//",e.slice(n.length)!==n?(t.preventDefault(),app.navigate(e,{trigger:!0})):void 0}),this},e}(Backbone.Router),window.app=new t,$(function(){return app.start()})}).call(this),function(){app.GoogleApi=function(){function t(t){this.perPage=null!=t?t:20,this.key="AIzaSyBh4CXjrAS1zFJPO_2KWTG5HavZnDjhjkQ"}return t.prototype.search=function(t,e,n){var r;return n||(n=e,e={}),e=$.extend({page:1},e),r=["id","volumeInfo/title","volumeInfo/subtitle","volumeInfo/authors","volumeInfo/description","volumeInfo/publisher","volumeInfo/publishedDate","volumeInfo/imageLinks","volumeInfo/categories","volumeInfo/mainCategory","volumeInfo/averageRating","volumeInfo/ratingsCount","volumeInfo/language","volumeInfo/industryIdentifiers","volumeInfo/imageLinks"].join(","),$.ajax({url:"https://www.googleapis.com/books/v1/volumes",data:{key:this.key,q:t,country:"us",startIndex:(e.page-1)*this.perPage,maxResults:this.perPage,callback:"callback",fields:"items("+r+"),totalItems"},dataType:"jsonp",error:function(){return console.log("Error",arguments)},success:n})},t}()}.call(this),function(){var t={}.hasOwnProperty,e=function(e,n){function r(){this.constructor=e}for(var i in n)t.call(n,i)&&(e[i]=n[i]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e};app.Book=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return e(n,t),n.parseGoogle=function(t){var e,n,r;return e=t.volumeInfo,{id:t.id,title:e.title,subtitle:e.subtitle,authors:e.authors,authorsStr:(e.authors||["unknown author"]).join(", "),description:e.description,averageRating:e.averageRating,ratingsCount:e.ratingsCount,categories:e.categories,image:null!=(n=e.imageLinks)?n.thumbnail:void 0,ISBN:null!=(r=e.industryIdentifiers[1])?r.identifier:void 0,language:e.language,publishedDate:Date.parse(e.publishedDate),publisher:e.publisher}},n.prototype.defaults={borrowedBy:!1,borrowedDate:null,title:null,subtitle:null,authors:null,authorsStr:null,description:null,averageRating:null,ratingsCount:null,categories:null,image:null,ISBN:null,language:null,publishedDate:null,publisher:null},n}(Backbone.Model),app.GoogleBooksCollection=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.model=app.Book,n.prototype.initialize=function(){return this.gapi=new app.GoogleApi},n.prototype.search=function(t){var e=this;return this.q=t,this.page=1,this.gapi.search(this.q,function(t){return e.total=t.totalItems,t=t.items.map(function(t){return app.Book.parseGoogle(t)}),e.reset(t)})},n.prototype.searchMore=function(){var t=this;return this.page+=1,this.gapi.search(this.q,{page:this.page},function(e){return e=e.items.map(function(t){return app.Book.parseGoogle(t)}),t.add(e)})},n.prototype.sync=function(){},n}(Backbone.Collection),app.MyBooksCollection=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.model=app.Book,n.prototype.localStorage=new Backbone.LocalStorage("MyShelf"),n}(Backbone.Collection),app.googleBooks=new app.GoogleBooksCollection,app.myBooks=new app.MyBooksCollection}.call(this),function(){var t={}.hasOwnProperty,e=function(e,n){function r(){this.constructor=e}for(var i in n)t.call(n,i)&&(e[i]=n[i]);return r.prototype=n.prototype,e.prototype=new r,e.__super__=n.prototype,e};app.SearchView=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.el="#search",n.prototype.events={"keypress input.search-query":"doSearch","click #loadMore":"moreSearch","click button.add":"toMyShelf","click button.remove":"fromMyShelf"},n.prototype.bookTemplate=_.template($("#bookTemplate").html()),n.prototype.initialize=function(){return _.bindAll(this,"addAllBooks","addOneBook","updateMyBook"),this.input=this.$(".search-query"),this.resultContainer=this.$("#search-results"),this.resultList=this.resultContainer.find(".list"),app.googleBooks.on("reset",this.addAllBooks),app.googleBooks.on("add",this.addOneBook),app.myBooks.on("add remove destroy",this.updateMyBook)},n.prototype.doSearch=function(t){return 13===t.keyCode?(this.preloader(!0),app.googleBooks.search(this.input.val())):void 0},n.prototype.moreSearch=function(){return this.preloader(!0),app.googleBooks.searchMore()},n.prototype.updateCounter=function(){return this.$(".found-count").html("Found "+app.googleBooks.total+" results. First "+app.googleBooks.length+" shown below.")},n.prototype.addOneBook=function(t){return this.resultList.append(this.bookTemplate(t.attributes)),$(".stars span").tooltip(),this.updateCounter(),this.preloader(!1)},n.prototype.addAllBooks=function(){return this.resultList.empty(),app.googleBooks.length>0&&$("#loadMore").show(),app.googleBooks.each(this.addOneBook)},n.prototype.preloader=function(t){return this.$(".form-search").toggleClass("preloader",t)},n.prototype.toMyShelf=function(t){var e;return e=app.googleBooks.get($(t.target).data("id")),app.myBooks.create(e.attributes)},n.prototype.fromMyShelf=function(t){var e;return e=app.myBooks.get($(t.target).data("id")),e.destroy()},n.prototype.updateMyBook=function(t){var e,n;return e=t.id,n=null!=app.myBooks.get(e),this.$("#book_"+e).toggleClass("onMyShelf",n)},n.prototype.render=function(){return this.addAllBooks(),this.$el.show()},n}(Backbone.View),app.MyShelfView=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.el="#my-shelf",n.prototype.events={"click button.remove":"removeBook","click button.give-away":"giveAwayBook","click button.submit-give-away":"submitGiveAwayBook","click button.cancel-give-away":"cancelGiveAwayBook","click button.take-back":"takeBackBook","keyup input.borrower-name":"keyup"},n.prototype.template=_.template($("#myShelfBookTemplate").html()),n.prototype.infoTemplate=_.template($("#bookTemplate").html()),n.prototype.initialize=function(){return _.bindAll(this,"addOneBook","addAllBooks","removeFromDOM","giveAwayBook","updateBook"),this.tableBody=this.$("table tbody"),app.myBooks.on("reset",this.addAllBooks),app.myBooks.on("add",this.addOneBook),app.myBooks.on("change",this.updateBook),app.myBooks.on("remove destroy",this.removeFromDOM)},n.prototype.modelFromEvent=function(t){return app.myBooks.get($(t.target).data("id"))},n.prototype.rowFromEvent=function(t){var e;return e=$(t.target).data("id"),$("#my_book_"+e)},n.prototype.keyup=function(t){return 13===t.keyCode?this.rowFromEvent(t).find("button.submit-give-away").click():void 0},n.prototype.giveAwayBook=function(t){var e;return e=this.rowFromEvent(t),e.find(".default-section").hide(),e.find(".submit-section").show(),e.find(".borrower-name-container").slideDown("fast"),e.find(".borrower-name").focus()},n.prototype.submitGiveAwayBook=function(t){var e,n,r=this;return n=this.rowFromEvent(t),e=n.find("input.borrower-name").val(),n.find(".borrower-name-container").slideUp("fast",function(){return r.modelFromEvent(t).set({borrowedBy:e,borrowedDate:(new Date).toString("yyyy-MM-ddTHH:mm:ssZ")}).save()})},n.prototype.cancelGiveAwayBook=function(t){var e=this;return this.rowFromEvent(t).find(".borrower-name-container").slideUp("fast",function(){return e.updateBook(e.modelFromEvent(t))})},n.prototype.takeBackBook=function(t){return this.modelFromEvent(t).set("borrowedBy",!1).save()},n.prototype.removeBook=function(t){return confirm("Are you sure want delete it?")?this.modelFromEvent(t).destroy():void 0},n.prototype.removeFromDOM=function(t){var e;return e=t.get("id"),$("#my_book_"+e).remove(),0===app.myBooks.length?this.$("tr.no-books").show():void 0},n.prototype.updateBook=function(t){var e;return e=t.get("id"),$("#my_book_"+e).replaceWith(this.template(t.attributes))},n.prototype.addOneBook=function(t){return this.tableBody.append(this.template(t.attributes)),this.$("tr.no-books").hide()},n.prototype.addAllBooks=function(){return this.tableBody.find("tr:not(.no-books)").remove(),0===app.myBooks.length&&this.$("tr.no-books").show(),app.myBooks.each(this.addOneBook)},n.prototype.showModelInfo=function(t){var e,n=this;return e=function(){var e,r;return e=app.myBooks.get(t).attributes,r=$("#modalInfo"),$(".modal-body",r).html(n.infoTemplate(e)),$("#modalInfoTitle").html(e.title).after(e.authorsStr),$(".titlePart",r).remove(),$("button.add, button.remove",r).remove(),r.modal(),r.on("hide",function(){return app.navigate("my-shelf",{trigger:!0})})},app.myBooks.length>0?e():app.myBooks.once("fetch reset",function(){return e()})},n.prototype.render=function(){return this.addAllBooks(),this.$el.show()},n}(Backbone.View),app.MainView=function(t){function n(){n.__super__.constructor.apply(this,arguments)}return e(n,t),n.prototype.el="body",n.prototype.events={"click .nav .search":"navigateLink","click .nav .my-shelf":"navigateLink"},n.prototype.initialize=function(){return _.bindAll(this,"updateMyBooksCount"),this.mainMenu=this.$el.find(".navbar:eq(0) .nav"),this.searchView=new app.SearchView,this.myShelfView=new app.MyShelfView,app.myBooks.on("add remove destroy fetch reset",this.updateMyBooksCount)},n.prototype.updateMyBooksCount=function(){return $("#myBooksCount").html(app.myBooks.length)},n.prototype.navigateLink=function(t){var e;return e=$(t.target).closest("a").attr("href"),app.navigate(e,{trigger:!0}),!1},n.prototype.activateMenu=function(t){return this.mainMenu.find("li").removeClass("active").filter("."+t).addClass("active")},n.prototype.hideContent=function(){return this.$el.find(".content").hide()},n.prototype.showSearch=function(){return this.activateMenu("search"),this.hideContent(),this.searchView.render()},n.prototype.showMyShelf=function(){return this.activateMenu("my-shelf"),this.hideContent(),this.myShelfView.render()},n}(Backbone.View)}.call(this);